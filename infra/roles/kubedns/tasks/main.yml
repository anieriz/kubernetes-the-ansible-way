# see https://github.com/kelseyhightower/kubernetes-the-hard-way/blob/master/docs/12-dns-addon.md
- name: ensure directories exist
  file:
    path: /opt/kubedns
    state: directory

- name: copy kube-dns.yaml
  copy:
    src: kube-dns.yaml
    dest: /opt/kubedns/kube-dns.yaml

- name: apply kube-dns Service, ServiceAccount, ConfigMap, Deployment
  shell: kubectl apply -f /opt/kubedns/kube-dns.yaml
  register: apply_kubedns_result

- name: Result of apply kube-dns
  debug:
    msg: "{{ apply_kubedns_result.stdout_lines }}"

# Create first Kubernetes Pod
- name: Delete busybox deployment, if already there
  shell: kubectl delete deployment.apps/busybox -n default
  ignore_errors: true

- name: Create a busybox deployment
  shell: kubectl run busybox --image=busybox --command -- sleep 3600

- name: Check if busybox deployment is running
  shell: kubectl get pods -l run=busybox
  register: busybox_result
  until: busybox_result.stdout.find("Running") != -1
  retries: 10
  delay: 10

- name: Show busybox kubectl get output
  debug:
    msg: "{{ busybox_result.stdout_lines }}"

- name: Gather Kubernetes nodes facts
  shell: kubectl get pods -l run=busybox --output=json
  register: pod

- set_fact:
    kubernetes_pod: "{{ pod.stdout | from_json }}"

# Extract Pod result
- debug:
    msg: "Extract Kubernetes node addresses"
  with_flattened:
    - "{{ kubernetes_pod['items']|map(attribute='metadata')|map(attribute='name')|list }}"
  register: pod_name_result

- set_fact:
    pod_name: "{{ pod_name_result.results[0].item }}"

- debug:
    msg: "Pod name: {{ pod_name }}"

- name: Execute a DNS lookup for the kubernetes service inside the busybox pod
  shell: "kubectl exec -ti {{ pod_name }} -- nslookup kubernetes"
  register: pod_internal_nslookup

- debug:
    msg:
      - "Pod internal nslookup result:"
      - "{{ pod_internal_nslookup.stdout_lines }}"